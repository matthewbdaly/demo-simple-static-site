<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="fb:app_id" content="1503502813234429"/>
        <link rel="stylesheet" type="text/css" href="/static/bower_components/bootstrap-sass/dist/css/bootstrap.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/static/bower_components/flat-ui/dist/css/flat-ui.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/static/bower_components/highlightjs/styles/zenburn.css" media="all" />
        <link rel="alternate" type="application/rss+xml" title="A Series of Quite Extraordinary Events - feed" href="/index.xml" />
        <title>A Series of Quite Extraordinary Events - Django Blog Tutorial - the Next Generation - Part 3</title>
    </head>
    <body>
        <header>
            <div class="container">
                <div class="page-header">
                    <h1>A Series of Quite Extraordinary Events</h1>
                    <h2>Being the blog of Matthew Daly Esquire</h2>
                    <nav>
                        <a href="/">Home</a> | <a href="/archive.html">Archives</a> | <a href="/about.html">About</a> | <a href="/rss.xml">RSS</a>
                    </nav>
                </div>
            </div>
        </header>

        <div class="container">
            <article class="post">
    
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
    
  <div class="title">
    <h1><a href="/posts/2014-01-03-django-blog-tutorial-the-next-generation-part-3.html">Django Blog Tutorial - the Next Generation - Part 3</a></h1>
  </div>
  <section>
    <p>Hello again! In this instalment, we&#39;re going to do the following:</p>
<ul>
<li>Add support for flat pages</li>
<li>Add support for multiple authors</li>
<li>Add a third-party comment system</li>
</ul>
<h2 id="flat-pages">Flat pages</h2>
<p>Django ships with a number of useful apps - we&#39;ve already used the admin interface. The flat pages app is another very handy app that comes with Django, and we&#39;ll use it to allow the blog author to create a handful of flat pages.</p>
<p>First of all, you&#39;ll need to install the flatpages app. Edit the <code>INSTALLED_APPS</code> setting as follows:</p>
<p>``` python django_tutorial_blog_ng/settings.py
INSTALLED_APPS = (
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;south&#39;,
    &#39;blogengine&#39;,
    &#39;django.contrib.sites&#39;,
    &#39;django.contrib.flatpages&#39;,
)</p>
<pre><code>Note that we needed to enable the `sites` framework <span class="keyword">as</span> well. Yo<span class="string">u'll also need to set the `SITE_ID` setting:

``` python django_tutorial_blog_ng/settings.py
SITE_ID = 1</code></pre>
<p>With that done, run <code>python manage.py syncdb</code> to create the required database tables. Now, let&#39;s use the <code>sqlall</code> command to take a look at the database structure generated for the flat pages:</p>
<pre><code class="lang-sql"><span class="operator"><span class="keyword">BEGIN</span>;</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"django_flatpage_sites"</span> (
    <span class="string">"id"</span> <span class="keyword">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,
    <span class="string">"flatpage_id"</span> <span class="keyword">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"site_id"</span> <span class="keyword">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">REFERENCES</span> <span class="string">"django_site"</span> (<span class="string">"id"</span>),
    <span class="keyword">UNIQUE</span> (<span class="string">"flatpage_id"</span>, <span class="string">"site_id"</span>)
)
;</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"django_flatpage"</span> (
    <span class="string">"id"</span> <span class="keyword">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,
    <span class="string">"url"</span> <span class="keyword">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"title"</span> <span class="keyword">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"content"</span> text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"enable_comments"</span> bool <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"template_name"</span> <span class="keyword">varchar</span>(<span class="number">70</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"registration_required"</span> bool <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)
;</span>
<span class="operator"><span class="keyword">CREATE</span> INDEX <span class="string">"django_flatpage_sites_872c4601"</span> <span class="keyword">ON</span> <span class="string">"django_flatpage_sites"</span> (<span class="string">"flatpage_id"</span>);</span>
<span class="operator"><span class="keyword">CREATE</span> INDEX <span class="string">"django_flatpage_sites_99732b5c"</span> <span class="keyword">ON</span> <span class="string">"django_flatpage_sites"</span> (<span class="string">"site_id"</span>);</span>
<span class="operator"><span class="keyword">CREATE</span> INDEX <span class="string">"django_flatpage_c379dc61"</span> <span class="keyword">ON</span> <span class="string">"django_flatpage"</span> (<span class="string">"url"</span>);</span>

<span class="operator"><span class="keyword">COMMIT</span>;</span></code></pre>
<p>As mentioned previously, all models in Django have an <code>id</code> attribute by default. Each flat page also has a URL, title, and content. </p>
<p>Also note the separate <code>django_flatpage_sites</code> table, which maps sites to flat pages. Django can run multiple sites from the same web app, and so flat pages must be allocated to a specific site. This relationship is a many-to-many relationship, so one flat page can appear on more than one site.</p>
<p>The other fields <a href="http://127.0.0.1:8000/admin/flatpages/flatpage/add/">are hidden by default in the admin</a> and can be ignored. Let&#39;s have a go with Django&#39;s handy shell to explore the flatpage. Run <code>python manage.py shell</code> and you&#39;ll be able to interact with your Django application interactively:</p>
<pre><code class="lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py shell
Python 2.7.6 (default, Nov 23 2013, 13:53:45)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.flatpages.models import *
&gt;&gt;&gt; FlatPage
&lt;class 'django.contrib.flatpages.models.FlatPage'&gt;
&gt;&gt;&gt; from django.contrib.sites.models import Site
&gt;&gt;&gt; Site.objects.all()
[&lt;Site: example.com&gt;]</code></pre>
<p>As you can see, <code>flatpages</code> is a Django app similar to the <code>blogengine</code> one, with its own models, as is <code>sites</code>. You can see that the <code>FlatPage</code> class is a model. We can create an instance of it and save it interactively:</p>
<pre><code class="lang-python"><span class="prompt">&gt;&gt;&gt; </span>f = FlatPage()
<span class="prompt">&gt;&gt;&gt; </span>f.url = <span class="string">'/about/'</span>
<span class="prompt">&gt;&gt;&gt; </span>f.title = <span class="string">'About me'</span>
<span class="prompt">&gt;&gt;&gt; </span>f.content = <span class="string">'All about me'</span>
<span class="prompt">&gt;&gt;&gt; </span>f.save()
<span class="prompt">&gt;&gt;&gt; </span>f.sites.add(Site.objects.all()[<span class="number">0</span>])
<span class="prompt">&gt;&gt;&gt; </span>f.save()</code></pre>
<p>Note that because the relationship between the site and the flat page is a many-to-many relationship, we need to save it first, then use the <code>add</code> method to add the site to the list of sites.</p>
<p>We can retrieve it:</p>
<pre><code class="lang-python"><span class="prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()
[&lt;FlatPage: /about/ -- About me&gt;]
<span class="prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()[<span class="number">0</span>]
&lt;FlatPage: /about/ -- About me&gt;
<span class="prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()[<span class="number">0</span>].title
<span class="string">u'About me'</span></code></pre>
<p>This command is often handy for debugging problems with your models interactively. If you now run the server and visit the admin, you should notice that the Flatpages app is now visible there, and the &#39;About me&#39; flat page is now shown in there.</p>
<p>Let&#39;s also take a look at the SQL required for the <code>Site</code> model. Run <code>python manage.py sqlall sites</code>:</p>
<pre><code class="lang-sql"><span class="operator"><span class="keyword">BEGIN</span>;</span>
<span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"django_site"</span> (
    <span class="string">"id"</span> <span class="keyword">integer</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,
    <span class="string">"domain"</span> <span class="keyword">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,
    <span class="string">"name"</span> <span class="keyword">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>
)
;</span>

<span class="operator"><span class="keyword">COMMIT</span>;</span></code></pre>
<p>Again, very simple - just a domain and a name.</p>
<p>So, now that we have a good idea of how the flat page system works, we can write a test for it. We don&#39;t need to write unit tests for the model because Django already does that, but we do need to write an acceptance test to ensure we can create flat pages and they will be where we expect them to be. Add the following to the top of the test file:</p>
<p>``` python blogengine/tests.py
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site</p>
<pre><code>
Now, before we write this test, there<span class="string">'s some duplication to resolve. We have two tests that subclass `LiveServerTestCase`, and both have the same method, `setUp`. We can save ourselves some hassle by creating a new class containing this method and having both these tests inherit from it. We'</span>ll do that now because the flat page test can also be based on it. Create the following <span class="class"><span class="keyword">class</span> <span class="title">just</span> <span class="title">after</span> `<span class="title">PostTest</span>`:</span>

``` python blogengine/tests.py
<span class="class"><span class="keyword">class</span> <span class="title">BaseAcceptanceTest</span><span class="params">(LiveServerTestCase)</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span>
        self.client = Client()</code></pre>
<p>Then remove the setUp method from each of the two tests based on <code>LiveServerTestCase</code>, and change their parent class to <code>BaseAcceptanceTest</code>:</p>
<p>``` python blogengine/tests.py
class AdminTest(BaseAcceptanceTest):</p>
<p>class PostViewTest(BaseAcceptanceTest):</p>
<pre><code>
With <span class="keyword">that</span> done, <span class="command">run</span> <span class="keyword">the</span> tests <span class="keyword">and</span> they should pass. Commit your changes:

``` bash
git add blogengine/tests.py django_tutorial_blog_ng/settings.py
git commit -m 'Added flatpages <span class="keyword">to</span> installed apps'</code></pre>
<p>Now we can get started in earnest on our test for the flat pages:</p>
<p>``` python blogengine/tests.py
class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):</p>
<pre><code>    <span class="comment"># Create flat page</span>
    page = FlatPage()
    page.url = '/<span class="keyword">about</span>/'
    page.title = 'About <span class="keyword">me</span>'
    page.content = 'All <span class="keyword">about</span> <span class="keyword">me</span>'
    page.save()

    <span class="comment"># Add the site</span>
    page.sites.add(Site.objects.all()[<span class="number">0</span>])
    page.save()

    <span class="comment"># Check new page saved</span>
    all_pages = FlatPage.objects.all()
    self.assertEquals(len(all_pages), <span class="number">1</span>)
    only_page = all_pages[<span class="number">0</span>]
    self.assertEquals(only_page, page)

    <span class="comment"># Check data correct</span>
    self.assertEquals(only_page.url, '/<span class="keyword">about</span>/')
    self.assertEquals(only_page.title, 'About <span class="keyword">me</span>')
    self.assertEquals(only_page.content, 'All <span class="keyword">about</span> <span class="keyword">me</span>')

    <span class="comment"># Get URL</span>
    page_url = only_page.get_absolute_url()

    <span class="comment"># Get the page</span>
    response = self.client.<span class="keyword">get</span>(page_url)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check title and content in response</span>
    self.assertTrue('About <span class="keyword">me</span>' <span class="keyword">in</span> response.content)
    self.assertTrue('All <span class="keyword">about</span> <span class="keyword">me</span>' <span class="keyword">in</span> response.content)</code></pre>
<pre><code>
<span class="comment">Let's</span> <span class="comment">run</span> <span class="comment">our</span> <span class="comment">tests:</span>

<span class="comment">```</span> <span class="comment">bash</span>
<span class="comment">(venv)Smith:django_tutorial_blog_ng</span> <span class="comment">matthewdaly$</span> <span class="comment">python</span> <span class="comment">manage</span>.<span class="comment">py</span> <span class="comment">test</span>
<span class="comment">Creating</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="comment">F</span>.<span class="string">.</span>
<span class="comment">======================================================================</span>
<span class="comment">FAIL:</span> <span class="comment">test_create_flat_page</span> <span class="comment">(blogengine</span>.<span class="comment">tests</span>.<span class="comment">FlatPageViewTest)</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Traceback</span> <span class="comment">(most</span> <span class="comment">recent</span> <span class="comment">call</span> <span class="comment">last):</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">272</span>, <span class="comment">in</span> <span class="comment">test_create_flat_page</span>
    <span class="comment">self</span>.<span class="comment">assertEquals(response</span>.<span class="comment">status_code</span>, <span class="comment">200)</span>
<span class="comment">AssertionError:</span> <span class="comment">404</span> <span class="comment">!=</span> <span class="comment">200</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Ran</span> <span class="comment">9</span> <span class="comment">tests</span> <span class="comment">in</span> <span class="comment">2</span>.<span class="comment">760s</span>

<span class="comment">FAILED</span> <span class="comment">(failures=1)</code></pre>
<p>We can see why it&#39;s failed - in our flat page test, the status code is 404, indicating the page was not found. This just means we haven&#39;t put flat page support into our URLconf. So let&#39;s fix that:</p>
<p>``` python django_tutorial_blog_ng/urls.py
from django.conf.urls import patterns, include, url</p>
<p>from django.contrib import admin
admin.autodiscover()</p>
<p>urlpatterns = patterns(&#39;&#39;,</p>
<pre><code><span class="comment"># Examples:</span>
<span class="comment"># url(r'^$', 'django_tutorial_blog_ng.views.home', name='home'),</span>
<span class="comment"># url(r'^blog/', include('blog.urls')),</span>

url(<span class="string">r'^admin/'</span>, include(admin.site.urls)),

<span class="comment"># Blog URLs</span>
url(<span class="string">r''</span>, include(<span class="string">'blogengine.urls'</span>)),

<span class="comment"># Flat pages</span>
url(<span class="string">r''</span>, include(<span class="string">'django.contrib.flatpages.urls'</span>)),</code></pre>
<p>)</p>
<pre><code>
<span class="comment">Let's</span> <span class="comment">run</span> <span class="comment">our</span> <span class="comment">tests</span> <span class="comment">again:</span>

<span class="comment">```</span> <span class="comment">bash</span>
<span class="comment">(venv)Smith:django_tutorial_blog_ng</span> <span class="comment">matthewdaly$</span> <span class="comment">python</span> <span class="comment">manage</span>.<span class="comment">py</span> <span class="comment">test</span>
<span class="comment">Creating</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="comment">E</span>.<span class="string">.</span>
<span class="comment">======================================================================</span>
<span class="comment">ERROR:</span> <span class="comment">test_create_flat_page</span> <span class="comment">(blogengine</span>.<span class="comment">tests</span>.<span class="comment">FlatPageViewTest)</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Traceback</span> <span class="comment">(most</span> <span class="comment">recent</span> <span class="comment">call</span> <span class="comment">last):</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">276</span>, <span class="comment">in</span> <span class="comment">test_create_flat_page</span>
    <span class="comment">response</span> <span class="comment">=</span> <span class="comment">self</span>.<span class="comment">client</span>.<span class="comment">get(page_url)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/test/client</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">473</span>, <span class="comment">in</span> <span class="comment">get</span>
    <span class="comment">response</span> <span class="comment">=</span> <span class="comment">super(Client</span>, <span class="comment">self)</span>.<span class="comment">get(path</span>, <span class="comment">data=data</span>, <span class="comment">**extra)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/test/client</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">280</span>, <span class="comment">in</span> <span class="comment">get</span>
    <span class="comment">return</span> <span class="comment">self</span>.<span class="comment">request(**r)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/test/client</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">444</span>, <span class="comment">in</span> <span class="comment">request</span>
    <span class="comment">six</span>.<span class="comment">reraise(*exc_info)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/core/handlers/base</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">114</span>, <span class="comment">in</span> <span class="comment">get_response</span>
    <span class="comment">response</span> <span class="comment">=</span> <span class="comment">wrapped_callback(request</span>, <span class="comment">*callback_args</span>, <span class="comment">**callback_kwargs)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/contrib/flatpages/views</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">45</span>, <span class="comment">in</span> <span class="comment">flatpage</span>
    <span class="comment">return</span> <span class="comment">render_flatpage(request</span>, <span class="comment">f)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/utils/decorators</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">99</span>, <span class="comment">in</span> <span class="comment">_wrapped_view</span>
    <span class="comment">response</span> <span class="comment">=</span> <span class="comment">view_func(request</span>, <span class="comment">*args</span>, <span class="comment">**kwargs)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/contrib/flatpages/views</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">60</span>, <span class="comment">in</span> <span class="comment">render_flatpage</span>
    <span class="comment">t</span> <span class="comment">=</span> <span class="comment">loader</span>.<span class="comment">get_template(DEFAULT_TEMPLATE)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/template/loader</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">138</span>, <span class="comment">in</span> <span class="comment">get_template</span>
    <span class="comment">template</span>, <span class="comment">origin</span> <span class="comment">=</span> <span class="comment">find_template(template_name)</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2</span>.<span class="comment">7/site</span>-<span class="comment">packages/django/template/loader</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">131</span>, <span class="comment">in</span> <span class="comment">find_template</span>
    <span class="comment">raise</span> <span class="comment">TemplateDoesNotExist(name)</span>
<span class="comment">TemplateDoesNotExist:</span> <span class="comment">flatpages/default</span>.<span class="comment">html</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Ran</span> <span class="comment">9</span> <span class="comment">tests</span> <span class="comment">in</span> <span class="comment">3</span>.<span class="comment">557s</span>

<span class="comment">FAILED</span> <span class="comment">(errors=1)</span>
<span class="comment">Destroying</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span></code></pre>
<p>Our test still fails, but we can easily see  why - the template <code>flatpages/default.html</code> doesn&#39;t exist. So we create it:</p>
<p>``` html templates/flatpages/default.html
{% raw %}{% extends &quot;blogengine/includes/base.html&quot; %}</p>
<pre><code><span class="template_tag">{% <span class="keyword">load</span> custom_markdown %}</span>

<span class="template_tag">{% <span class="keyword">block</span> content %}</span>
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"post"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="variable">{{ flatpage.title }}</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
    <span class="variable">{{ flatpage.content<span class="filter">|custom</span>_markdown }}</span>
    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>

<span class="template_tag">{% <span class="keyword">endblock</span> %}</span><span class="template_tag">{% endraw %}</span></code></pre>
<pre><code>
This template <span class="keyword">is</span> based <span class="function_start"><span class="keyword">on</span> <span class="title">the</span></span> blog post one, <span class="keyword">and</span> just changes a handful <span class="keyword">of</span> variable names. Note <span class="keyword">that</span> <span class="keyword">it</span> can still inherit <span class="keyword">from</span> <span class="keyword">the</span> blogengine base template, <span class="keyword">and</span> <span class="keyword">in</span> this case we're using <span class="keyword">that</span> <span class="keyword">for</span> <span class="keyword">the</span> sake <span class="keyword">of</span> consistency.

If you <span class="command">run</span> your tests, you should now see <span class="keyword">that</span> they pass, so we'll commit our changes:

``` bash
git add templates/ django_tutorial_blog_ng/ blogengine/
git commit -m 'Implemented flat page support'</code></pre>
<h2 id="multiple-authors">Multiple authors</h2>
<p>Next we&#39;ll add support for multiple authors. Now, Django already has a User model, and we&#39;ll leverage that to represent the authors. But first we&#39;ll write our test:</p>
<p>``` python blogengine/tests/py
from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown</p>
<h1 id="create-your-tests-here-">Create your tests here.</h1>
<p>class PostTest(TestCase):
    def test_create_post(self):</p>
<pre><code>    <span class="comment"># Create the author</span>
    author = User.objects.create_user('testuser', 'user@example.com', 'password')
    author.save()

    <span class="comment"># Create the post</span>
    post = Post()

    <span class="comment"># Set the attributes</span>
    post.title = 'My <span class="keyword">first</span> post'
    post.<span class="type">text</span> = 'This <span class="keyword">is</span> <span class="keyword">my</span> <span class="keyword">first</span> blog post'
    post.slug = '<span class="keyword">my</span>-<span class="keyword">first</span>-post'
    post.pub_date = timezone.now()
    post.author = author

    <span class="comment"># Save it</span>
    post.save()

    <span class="comment"># Check we can find it</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)
    only_post = all_posts[<span class="number">0</span>]
    self.assertEquals(only_post, post)

    <span class="comment"># Check attributes</span>
    self.assertEquals(only_post.title, 'My <span class="keyword">first</span> post')
    self.assertEquals(only_post.<span class="type">text</span>, 'This <span class="keyword">is</span> <span class="keyword">my</span> <span class="keyword">first</span> blog post')
    self.assertEquals(only_post.slug, '<span class="keyword">my</span>-<span class="keyword">first</span>-post')
    self.assertEquals(only_post.pub_date.<span class="property">day</span>, post.pub_date.<span class="property">day</span>)
    self.assertEquals(only_post.pub_date.<span class="property">month</span>, post.pub_date.<span class="property">month</span>)
    self.assertEquals(only_post.pub_date.<span class="property">year</span>, post.pub_date.<span class="property">year</span>)
    self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
    self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
    self.assertEquals(only_post.pub_date.<span class="keyword">second</span>, post.pub_date.<span class="keyword">second</span>)
    self.assertEquals(only_post.author.username, 'testuser')
    self.assertEquals(only_post.author.email, 'user@example.com')</code></pre>
<p>class BaseAcceptanceTest(LiveServerTestCase):
    def setUp(self):
        self.client = Client()</p>
<p>class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">test_login</span><span class="params">(self)</span>:</span>
    <span class="comment"># Get login page</span>
    response = self.client.get(<span class="string">'/admin/'</span>)

    <span class="comment"># Check response code</span>
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log in' in response</span>
    self.assertTrue(<span class="string">'Log in'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Log the user in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log out' in response</span>
    self.assertTrue(<span class="string">'Log out'</span> <span class="keyword">in</span> response.content)

<span class="function"><span class="keyword">def</span> <span class="title">test_logout</span><span class="params">(self)</span>:</span>
    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log out' in response</span>
    self.assertTrue(<span class="string">'Log out'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Log out</span>
    self.client.logout()

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log in' in response</span>
    self.assertTrue(<span class="string">'Log in'</span> <span class="keyword">in</span> response.content)

<span class="function"><span class="keyword">def</span> <span class="title">test_create_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/blogengine/post/add/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Create the new post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/add/'</span>, {
        <span class="string">'title'</span>: <span class="string">'My first post'</span>,
        <span class="string">'text'</span>: <span class="string">'This is my first post'</span>,
        <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
        <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
        <span class="string">'slug'</span>: <span class="string">'my-first-post'</span>
    },
    follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check added successfully</span>
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check new post now in database</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_edit_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the author</span>
    author = User.objects.create_user(<span class="string">'testuser'</span>, <span class="string">'user@example.com'</span>, <span class="string">'password'</span>)
    author.save()

    <span class="comment"># Create the post</span>
    post = Post()
    post.title = <span class="string">'My first post'</span>
    post.text = <span class="string">'This is my first blog post'</span>
    post.slug = <span class="string">'my-first-post'</span>
    post.pub_date = timezone.now()
    post.author = author
    post.save()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Edit the post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/1/'</span>, {
        <span class="string">'title'</span>: <span class="string">'My second post'</span>,
        <span class="string">'text'</span>: <span class="string">'This is my second blog post'</span>,
        <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
        <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
        <span class="string">'slug'</span>: <span class="string">'my-second-post'</span>
    },
    follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check changed successfully</span>
    self.assertTrue(<span class="string">'changed successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check post amended</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)
    only_post = all_posts[<span class="number">0</span>]
    self.assertEquals(only_post.title, <span class="string">'My second post'</span>)
    self.assertEquals(only_post.text, <span class="string">'This is my second blog post'</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_delete_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the author</span>
    author = User.objects.create_user(<span class="string">'testuser'</span>, <span class="string">'user@example.com'</span>, <span class="string">'password'</span>)
    author.save()

    <span class="comment"># Create the post</span>
    post = Post()
    post.title = <span class="string">'My first post'</span>
    post.text = <span class="string">'This is my first blog post'</span>
    post.slug = <span class="string">'my-first-post'</span>
    post.pub_date = timezone.now()
    post.author = author
    post.save()

    <span class="comment"># Check new post saved</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Delete the post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/1/delete/'</span>, {
        <span class="string">'post'</span>: <span class="string">'yes'</span>
    }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check deleted successfully</span>
    self.assertTrue(<span class="string">'deleted successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check post amended</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">0</span>)</code></pre>
<p>class PostViewTest(BaseAcceptanceTest):
    def test_index(self):</p>
<pre><code>    # Create the author
    author = User.objects.create_user(<span class="comment">'testuser', 'user@example.com', 'password')</span>
    author.save()

    # Create the post
    post = Post()
    post.title = <span class="comment">'My first post'</span>
    post.text = <span class="comment">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
    post.slug = <span class="comment">'my-first-post'</span>
    post.pub_date = timezone.<span class="built_in">now</span>()
    post.author = author
    post.save()

    # Check <span class="keyword">new</span> post saved
    all_posts = Post.objects.all()
    self.assertEquals(<span class="built_in">len</span>(all_posts), <span class="number">1</span>)

    # Fetch the index
    <span class="built_in">response</span> = self.client.<span class="keyword">get</span>(<span class="comment">'/')</span>
    self.assertEquals(<span class="built_in">response</span>.status_code, <span class="number">200</span>)

    # Check the post title <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(post.title <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the post text <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(markdown.markdown(post.text) <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the post <span class="built_in">date</span> <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(str(post.pub_date.<span class="built_in">year</span>) <span class="keyword">in</span> <span class="built_in">response</span>.content)
    self.assertTrue(post.pub_date.strftime(<span class="comment">'%b') in response.content)</span>
    self.assertTrue(str(post.pub_date.<span class="built_in">day</span>) <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the link <span class="keyword">is</span> marked up properly
    self.assertTrue(<span class="comment">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;' in response.content)</span>

def test_post_page(self):
    # Create the author
    author = User.objects.create_user(<span class="comment">'testuser', 'user@example.com', 'password')</span>
    author.save()

    # Create the post
    post = Post()
    post.title = <span class="comment">'My first post'</span>
    post.text = <span class="comment">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
    post.slug = <span class="comment">'my-first-post'</span>
    post.pub_date = timezone.<span class="built_in">now</span>()
    post.author = author
    post.save()

    # Check <span class="keyword">new</span> post saved
    all_posts = Post.objects.all()
    self.assertEquals(<span class="built_in">len</span>(all_posts), <span class="number">1</span>)
    only_post = all_posts[<span class="number">0</span>]
    self.assertEquals(only_post, post)

    # <span class="keyword">Get</span> the post URL
    post_url = only_post.get_absolute_url()

    # Fetch the post
    <span class="built_in">response</span> = self.client.<span class="keyword">get</span>(post_url)
    self.assertEquals(<span class="built_in">response</span>.status_code, <span class="number">200</span>)

    # Check the post title <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(post.title <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the post text <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(markdown.markdown(post.text) <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the post <span class="built_in">date</span> <span class="keyword">is</span> <span class="keyword">in</span> the <span class="built_in">response</span>
    self.assertTrue(str(post.pub_date.<span class="built_in">year</span>) <span class="keyword">in</span> <span class="built_in">response</span>.content)
    self.assertTrue(post.pub_date.strftime(<span class="comment">'%b') in response.content)</span>
    self.assertTrue(str(post.pub_date.<span class="built_in">day</span>) <span class="keyword">in</span> <span class="built_in">response</span>.content)

    # Check the link <span class="keyword">is</span> marked up properly
    self.assertTrue(<span class="comment">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;' in response.content)</span></code></pre>
<p>class FlatPageViewTest(BaseAcceptanceTest):
    def test_create_flat_page(self):</p>
<pre><code>    <span class="comment"># Create flat page</span>
    page = FlatPage()
    page.url = '/<span class="keyword">about</span>/'
    page.title = 'About <span class="keyword">me</span>'
    page.content = 'All <span class="keyword">about</span> <span class="keyword">me</span>'
    page.save()

    <span class="comment"># Add the site</span>
    page.sites.add(Site.objects.all()[<span class="number">0</span>])
    page.save()

    <span class="comment"># Check new page saved</span>
    all_pages = FlatPage.objects.all()
    self.assertEquals(len(all_pages), <span class="number">1</span>)
    only_page = all_pages[<span class="number">0</span>]
    self.assertEquals(only_page, page)

    <span class="comment"># Check data correct</span>
    self.assertEquals(only_page.url, '/<span class="keyword">about</span>/')
    self.assertEquals(only_page.title, 'About <span class="keyword">me</span>')
    self.assertEquals(only_page.content, 'All <span class="keyword">about</span> <span class="keyword">me</span>')

    <span class="comment"># Get URL</span>
    page_url = str(only_page.get_absolute_url())

    <span class="comment"># Get the page</span>
    response = self.client.<span class="keyword">get</span>(page_url)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check title and content in response</span>
    self.assertTrue('About <span class="keyword">me</span>' <span class="keyword">in</span> response.content)
    self.assertTrue('All <span class="keyword">about</span> <span class="keyword">me</span>' <span class="keyword">in</span> response.content)</code></pre>
<pre><code>
<span class="comment">Here</span> <span class="comment">we</span> <span class="comment">create</span> <span class="comment">a</span> <span class="comment">`User`</span> <span class="comment">object</span> <span class="comment">to</span> <span class="comment">represent</span> <span class="comment">the</span> <span class="comment">author</span>. <span class="comment">Note</span> <span class="comment">the</span> <span class="comment">`create_user`</span> <span class="comment">convenience</span> <span class="comment">method</span> <span class="comment">for</span> <span class="comment">creating</span> <span class="comment">new</span> <span class="comment">users</span> <span class="comment">quickly</span> <span class="comment">and</span> <span class="comment">easily</span>.

<span class="comment">We're</span> <span class="comment">going</span> <span class="comment">to</span> <span class="comment">exclude</span> <span class="comment">the</span> <span class="comment">author</span> <span class="comment">field</span> <span class="comment">from</span> <span class="comment">the</span> <span class="comment">admin</span> <span class="literal">-</span> <span class="comment">instead</span> <span class="comment">it's</span> <span class="comment">going</span> <span class="comment">to</span> <span class="comment">be</span> <span class="comment">automatically</span> <span class="comment">populated</span> <span class="comment">based</span> <span class="comment">on</span> <span class="comment">the</span> <span class="comment">session</span> <span class="comment">data</span>, <span class="comment">so</span> <span class="comment">that</span> <span class="comment">when</span> <span class="comment">a</span> <span class="comment">user</span> <span class="comment">creates</span> <span class="comment">a</span> <span class="comment">post</span> <span class="comment">they</span> <span class="comment">are</span> <span class="comment">automatically</span> <span class="comment">set</span> <span class="comment">as</span> <span class="comment">the</span> <span class="comment">author</span>. <span class="comment">We</span> <span class="comment">therefore</span> <span class="comment">don't</span> <span class="comment">need</span> <span class="comment">to</span> <span class="comment">make</span> <span class="comment">any</span> <span class="comment">changes</span> <span class="comment">for</span> <span class="comment">the</span> <span class="comment">acceptance</span> <span class="comment">tests</span> <span class="comment">for</span> <span class="comment">posts</span> <span class="literal">-</span> <span class="comment">our</span> <span class="comment">changes</span> <span class="comment">to</span> <span class="comment">the</span> <span class="comment">unit</span> <span class="comment">tests</span> <span class="comment">for</span> <span class="comment">the</span> <span class="comment">`Post`</span> <span class="comment">model</span> <span class="comment">are</span> <span class="comment">sufficient</span>.

<span class="comment">Run</span> <span class="comment">the</span> <span class="comment">tests</span>, <span class="comment">and</span> <span class="comment">they</span> <span class="comment">should</span> <span class="comment">fail:</span>

<span class="comment">```</span> <span class="comment">python</span> <span class="comment">blogengine/tests/py</span>
<span class="comment">(venv)Smith:django_tutorial_blog_ng</span> <span class="comment">matthewdaly$</span> <span class="comment">python</span> <span class="comment">manage</span>.<span class="comment">py</span> <span class="comment">test</span>
<span class="comment">Creating</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span>
<span class="comment">E</span>.<span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="comment">======================================================================</span>
<span class="comment">ERROR:</span> <span class="comment">test_create_post</span> <span class="comment">(blogengine</span>.<span class="comment">tests</span>.<span class="comment">PostTest)</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Traceback</span> <span class="comment">(most</span> <span class="comment">recent</span> <span class="comment">call</span> <span class="comment">last):</span>
  <span class="comment">File</span> <span class="comment">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests</span>.<span class="comment">py"</span>, <span class="comment">line</span> <span class="comment">45</span>, <span class="comment">in</span> <span class="comment">test_create_post</span>
    <span class="comment">self</span>.<span class="comment">assertEquals(only_post</span>.<span class="comment">author</span>.<span class="comment">username</span>, <span class="comment">'testuser')</span>
<span class="comment">AttributeError:</span> <span class="comment">'Post'</span> <span class="comment">object</span> <span class="comment">has</span> <span class="comment">no</span> <span class="comment">attribute</span> <span class="comment">'author'</span>

<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Ran</span> <span class="comment">9</span> <span class="comment">tests</span> <span class="comment">in</span> <span class="comment">3</span>.<span class="comment">620s</span>

<span class="comment">FAILED</span> <span class="comment">(errors=1)</span>
<span class="comment">Destroying</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span></code></pre>
<p>Let&#39;s add the missing <code>author</code> attribute:</p>
<p>``` python blogengine/models.py
from django.db import models
from django.contrib.auth.models import User</p>
<h1 id="create-your-models-here-">Create your models here.</h1>
<p>class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span>
    <span class="keyword">return</span> <span class="string">"/%s/%s/%s/"</span> % (self.pub_date.year, self.pub_date.month, self.slug)

<span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span>
    <span class="keyword">return</span> self.title

<span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span>
    ordering = [<span class="string">"-pub_date"</span>]</code></pre>
<pre><code>
Next, <span class="operator"><span class="keyword">create</span> the migrations:

<span class="string">``</span><span class="string">` bash
python manage.py schemamigration --auto blogengine</code></pre>
<p>You&#39;ll be prompted to either quit or provide a default author ID - select option 2 to provide the ID, then enter 1, which should be your own user account ID. Then run the migrations:</p>
<pre><code class="lang-bash">python manage.py migrate</code></pre>
<p>Let&#39;s run our tests again:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database <span class="keyword">for</span> alias <span class="string">'default'</span>...
.F.F.....
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 118, <span class="keyword">in</span> test_create_post
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 154, <span class="keyword">in</span> test_edit_post
    self.assertTrue(<span class="string">'changed successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

----------------------------------------------------------------------
Ran 9 tests <span class="keyword">in</span> 3.390s

FAILED (failures=2)
Destroying test database <span class="keyword">for</span> alias <span class="string">'default'</span>...</code></pre>
<p>Our test still fails because the author field isn&#39;t set automatically. So we&#39;ll amend the admin to automatically set the author when the <code>Post</code> object is saved:</p>
<p>``` python blogengine/admin.py
import models
from django.contrib import admin
from django.contrib.auth.models import User</p>
<p>class PostAdmin(admin.ModelAdmin):
    prepopulated_fields = {&quot;slug&quot;: (&quot;title&quot;,)}
    exclude = (&#39;author&#39;,)</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">save_model</span><span class="params">(self, request, obj, form, change)</span>:</span>
    obj.author = request.user
    obj.save()</code></pre>
<p>admin.site.register(models.Post, PostAdmin)</p>
<pre><code>
<span class="comment">This</span> <span class="comment">tells</span> <span class="comment">the</span> <span class="comment">admin</span> <span class="comment">to</span> <span class="comment">exclude</span> <span class="comment">the</span> <span class="comment">`author`</span> <span class="comment">field</span> <span class="comment">from</span> <span class="comment">any</span> <span class="comment">form</span> <span class="comment">for</span> <span class="comment">a</span> <span class="comment">post</span>, <span class="comment">and</span> <span class="comment">when</span> <span class="comment">the</span> <span class="comment">model</span> <span class="comment">is</span> <span class="comment">saved</span>, <span class="comment">to</span> <span class="comment">set</span> <span class="comment">the</span> <span class="comment">author</span> <span class="comment">to</span> <span class="comment">the</span> <span class="comment">user</span> <span class="comment">making</span> <span class="comment">the</span> <span class="comment">HTTP</span> <span class="comment">request</span>. <span class="comment">Now</span> <span class="comment">run</span> <span class="comment">the</span> <span class="comment">tests</span>, <span class="comment">and</span> <span class="comment">they</span> <span class="comment">should</span> <span class="comment">pass:</span>

<span class="comment">```</span> <span class="comment">bash</span>
<span class="comment">(venv)Smith:django_tutorial_blog_ng</span> <span class="comment">matthewdaly$</span> <span class="comment">python</span> <span class="comment">manage</span>.<span class="comment">py</span> <span class="comment">test</span>
<span class="comment">Creating</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Ran</span> <span class="comment">9</span> <span class="comment">tests</span> <span class="comment">in</span> <span class="comment">4</span>.<span class="comment">086s</span>

<span class="comment">OK</span>
<span class="comment">Destroying</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span></code></pre>
<p>Time to commit again:</p>
<pre><code class="lang-bash">git add blogengine/
git commit -m <span class="string">'Added author field'</span></code></pre>
<h2 id="comments">Comments</h2>
<p>The <a href="http://matthewdaly.co.uk/blog/2012/03/29/yet-another-tutorial-for-building-a-blog-using-python-and-django-part-4/">previous version of this tutorial</a> implemented comments using Django&#39;s own comment system. However, this has since been deprecated from Django and turned into <a href="https://github.com/django/django-contrib-comments">a separate project</a>. So we have two options for how to implement comments:</p>
<ul>
<li>We can use <a href="http://django-contrib-comments.readthedocs.org/en/latest/">the comments system</a></li>
<li>We can use a third-party comments system</li>
</ul>
<p>Now, if you want to use the Django comment system, you can do so, and it shouldn&#39;t be too hard to puzzle out how to implement it using the documentation and my prior post. However, in my humble opinion, using a third-party comment system is the way to go for blog comments - they make it extremely easy for people to log in with multiple services without you having to write lots of additional code. They also make it significantly easier to moderate comments, and they&#39;re generally pretty good at handling comment spam.</p>
<p>Some of the available providers include:</p>
<ul>
<li><a href="http://disqus.com/">Disqus</a></li>
<li><a href="http://intensedebate.com/">IntenseDebate</a></li>
<li><a href="https://developers.facebook.com/docs/plugins/comments/">Facebook</a></li>
</ul>
<p>For demonstration purposes, we&#39;ll use Facebook comments, but this shouldn&#39;t require much work to adapt it to the other providers.</p>
<p>First of all, we need to include the Facebook JavaScript SDK:</p>
<p>``` html templates/blogengine/includes/base.html
        <!-- Add your site or application content here --></p>
<pre><code>    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"fb-root"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>
    <span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">(<span class="keyword">function</span>(d, s, id) {
        <span class="keyword">var</span> js, fjs = d.getElementsByTagName(s)[<span class="number">0</span>];
        <span class="keyword">if</span> (d.getElementById(id)) <span class="keyword">return</span>;
            js = d.createElement(s); js.id = id;
            js.src = <span class="string">"//connect.facebook.net/en_GB/all.js#xfbml=1"</span>;
            fjs.parentNode.insertBefore(js, fjs);
        }(document, <span class="string">'script'</span>, <span class="string">'facebook-jssdk'</span>));</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>

    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"navbar navbar-static-top navbar-inverse"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"navbar-inner"</span>&gt;</span>
            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span>
                <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"btn btn-navbar"</span> <span class="attribute">data-toggle</span>=<span class="value">"collapse"</span> <span class="attribute">data-target</span>=<span class="value">".nav-collapse"</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
                <span class="tag">&lt;/<span class="title">a</span>&gt;</span>
                <span class="tag">&lt;<span class="title">a</span> <span class="attribute">class</span>=<span class="value">"brand"</span> <span class="attribute">href</span>=<span class="value">"/"</span>&gt;</span>My Django Blog<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
                <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"nav-collapse collapse"</span>&gt;</span>
                <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">div</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>
<pre><code>
Now, the Facebook comment system requires that you pass through the absolute page<span class="constant"> URL </span>when initialising the comments. At present we can<span class="string">'t do that without hard-coding the domain name in our template, which we want to avoid. So, we need to add a site field to each post to identify the site it'</span>s associated with.

As usual, we update our tests first:

``` python blogengine/tests.py
from django.test import TestCase, LiveServerTestCase, Client
from django.utils import timezone
from blogengine.models import Post
from django.contrib.flatpages.models import FlatPage
from django.contrib.sites.models import Site
from django.contrib.auth.models import User
import markdown

<span class="preprocessor"># Create your tests here.</span>
<span class="class"><span class="keyword">class</span> <span class="title">PostTest</span>(<span class="title">TestCase</span>):
    <span class="title">def</span> <span class="title">test_create_post</span>(<span class="title">self</span>):
        # <span class="title">Create</span> <span class="title">the</span> <span class="title">author</span>
        <span class="title">author</span> = <span class="title">User</span>.<span class="title">objects</span>.<span class="title">create_user</span>('<span class="title">testuser</span>', '<span class="title">user</span>@<span class="title">example</span>.<span class="title">com</span>', '<span class="title">password</span>')
        <span class="title">author</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">site</span>
        <span class="title">site</span> = <span class="title">Site</span>()
        <span class="title">site</span>.<span class="title">name</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">domain</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">post</span>
        <span class="title">post</span> = <span class="title">Post</span>()

        # <span class="title">Set</span> <span class="title">the</span> <span class="title">attributes</span>
        <span class="title">post</span>.<span class="title">title</span> = '<span class="title">My</span> <span class="title">first</span> <span class="title">post</span>'
        <span class="title">post</span>.<span class="title">text</span> = '<span class="title">This</span> <span class="title">is</span> <span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>'
        <span class="title">post</span>.<span class="title">slug</span> = '<span class="title">my</span>-<span class="title">first</span>-<span class="title">post</span>'
        <span class="title">post</span>.<span class="title">pub_date</span> = <span class="title">timezone</span>.<span class="title">now</span>()
        <span class="title">post</span>.<span class="title">author</span> = <span class="title">author</span>
        <span class="title">post</span>.<span class="title">site</span> = <span class="title">site</span>

        # <span class="title">Save</span> <span class="title">it</span>
        <span class="title">post</span>.<span class="title">save</span>()

        # <span class="title">Check</span> <span class="title">we</span> <span class="title">can</span> <span class="title">find</span> <span class="title">it</span>
        <span class="title">all_posts</span> = <span class="title">Post</span>.<span class="title">objects</span>.<span class="title">all</span>()
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">len</span>(<span class="title">all_posts</span>), 1)
        <span class="title">only_post</span> = <span class="title">all_posts</span>[0]
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>, <span class="title">post</span>)

        # <span class="title">Check</span> <span class="title">attributes</span>
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">title</span>, '<span class="title">My</span> <span class="title">first</span> <span class="title">post</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">text</span>, '<span class="title">This</span> <span class="title">is</span> <span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">slug</span>, '<span class="title">my</span>-<span class="title">first</span>-<span class="title">post</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">site</span>.<span class="title">name</span>, '<span class="title">example</span>.<span class="title">com</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">site</span>.<span class="title">domain</span>, '<span class="title">example</span>.<span class="title">com</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">day</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">day</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">month</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">month</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">year</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">year</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">hour</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">hour</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">minute</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">minute</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">pub_date</span>.<span class="title">second</span>, <span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">second</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">author</span>.<span class="title">username</span>, '<span class="title">testuser</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>.<span class="title">author</span>.<span class="title">email</span>, '<span class="title">user</span>@<span class="title">example</span>.<span class="title">com</span>')

<span class="title">class</span> <span class="title">BaseAcceptanceTest</span>(<span class="title">LiveServerTestCase</span>):
    <span class="title">def</span> <span class="title">setUp</span>(<span class="title">self</span>):
        <span class="title">self</span>.<span class="title">client</span> = <span class="title">Client</span>()


<span class="title">class</span> <span class="title">AdminTest</span>(<span class="title">BaseAcceptanceTest</span>):
    <span class="title">fixtures</span> = ['<span class="title">users</span>.<span class="title">json</span>']

    <span class="title">def</span> <span class="title">test_login</span>(<span class="title">self</span>):
        # <span class="title">Get</span> <span class="title">login</span> <span class="title">page</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/<span class="title">admin</span>/')

        # <span class="title">Check</span> <span class="title">response</span> <span class="title">code</span>
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> '<span class="title">Log</span> <span class="title">in</span>' <span class="title">in</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">Log</span> <span class="title">in</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Log</span> <span class="title">the</span> <span class="title">user</span> <span class="title">in</span>
        <span class="title">self</span>.<span class="title">client</span>.<span class="title">login</span>(<span class="title">username</span>='<span class="title">bobsmith</span>', <span class="title">password</span>="<span class="title">password</span>")

        # <span class="title">Check</span> <span class="title">response</span> <span class="title">code</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/<span class="title">admin</span>/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> '<span class="title">Log</span> <span class="title">out</span>' <span class="title">in</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">Log</span> <span class="title">out</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

    <span class="title">def</span> <span class="title">test_logout</span>(<span class="title">self</span>):
        # <span class="title">Log</span> <span class="title">in</span>
        <span class="title">self</span>.<span class="title">client</span>.<span class="title">login</span>(<span class="title">username</span>='<span class="title">bobsmith</span>', <span class="title">password</span>="<span class="title">password</span>")

        # <span class="title">Check</span> <span class="title">response</span> <span class="title">code</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/<span class="title">admin</span>/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> '<span class="title">Log</span> <span class="title">out</span>' <span class="title">in</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">Log</span> <span class="title">out</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Log</span> <span class="title">out</span>
        <span class="title">self</span>.<span class="title">client</span>.<span class="title">logout</span>()

        # <span class="title">Check</span> <span class="title">response</span> <span class="title">code</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/<span class="title">admin</span>/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> '<span class="title">Log</span> <span class="title">in</span>' <span class="title">in</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">Log</span> <span class="title">in</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

    <span class="title">def</span> <span class="title">test_create_post</span>(<span class="title">self</span>):
        # <span class="title">Log</span> <span class="title">in</span>
        <span class="title">self</span>.<span class="title">client</span>.<span class="title">login</span>(<span class="title">username</span>='<span class="title">bobsmith</span>', <span class="title">password</span>="<span class="title">password</span>")

        # <span class="title">Check</span> <span class="title">response</span> <span class="title">code</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/<span class="title">admin</span>/<span class="title">blogengine</span>/<span class="title">post</span>/<span class="title">add</span>/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">new</span> <span class="title">post</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">post</span>('/<span class="title">admin</span>/<span class="title">blogengine</span>/<span class="title">post</span>/<span class="title">add</span>/', {</span>
            <span class="string">'title'</span>: <span class="string">'My first post'</span>,
            <span class="string">'text'</span>: <span class="string">'This is my first post'</span>,
            <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
            <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
            <span class="string">'slug'</span>: <span class="string">'my-first-post'</span>,
            <span class="string">'site'</span>: <span class="string">'1'</span>
        },
        follow=True
        )
        self.assertEquals(response.status_code, <span class="number">200</span>)

        # Check added successfully
        self.assertTrue(<span class="string">'added successfully'</span> in response.content)

        # Check <span class="keyword">new</span> post now in database
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="number">1</span>)

    def test_edit_post(self):
        # Create the author
        author = User.objects.create_user(<span class="string">'testuser'</span>, <span class="string">'user@example.com'</span>, <span class="string">'password'</span>)
        author.save()

        # Create the site
        site = Site()
        site.name = <span class="string">'example.com'</span>
        site.domain = <span class="string">'example.com'</span>
        site.save()

        # Create the post
        post = Post()
        post.title = <span class="string">'My first post'</span>
        post.text = <span class="string">'This is my first blog post'</span>
        post.slug = <span class="string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        # Log in
        self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

        # Edit the post
        response = self.client.post(<span class="string">'/admin/blogengine/post/1/'</span>, {
            <span class="string">'title'</span>: <span class="string">'My second post'</span>,
            <span class="string">'text'</span>: <span class="string">'This is my second blog post'</span>,
            <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
            <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
            <span class="string">'slug'</span>: <span class="string">'my-second-post'</span>,
            <span class="string">'site'</span>: <span class="string">'1'</span>
        },
        follow=True
        )
        self.assertEquals(response.status_code, <span class="number">200</span>)

        # Check changed successfully
        self.assertTrue(<span class="string">'changed successfully'</span> in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="number">1</span>)
        only_post = all_posts[<span class="number">0</span>]
        self.assertEquals(only_post.title, <span class="string">'My second post'</span>)
        self.assertEquals(only_post.text, <span class="string">'This is my second blog post'</span>)

    def test_delete_post(self):
        # Create the author
        author = User.objects.create_user(<span class="string">'testuser'</span>, <span class="string">'user@example.com'</span>, <span class="string">'password'</span>)
        author.save()

        # Create the site
        site = Site()
        site.name = <span class="string">'example.com'</span>
        site.domain = <span class="string">'example.com'</span>
        site.save()

        # Create the post
        post = Post()
        post.title = <span class="string">'My first post'</span>
        post.text = <span class="string">'This is my first blog post'</span>
        post.slug = <span class="string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.save()

        # Check <span class="keyword">new</span> post saved
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="number">1</span>)

        # Log in
        self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

        # Delete the post
        response = self.client.post(<span class="string">'/admin/blogengine/post/1/delete/'</span>, {
            <span class="string">'post'</span>: <span class="string">'yes'</span>
        }, follow=True)
        self.assertEquals(response.status_code, <span class="number">200</span>)

        # Check deleted successfully
        self.assertTrue(<span class="string">'deleted successfully'</span> in response.content)

        # Check post amended
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="number">0</span>)

<span class="class"><span class="keyword">class</span> <span class="title">PostViewTest</span>(<span class="title">BaseAcceptanceTest</span>):
    <span class="title">def</span> <span class="title">test_index</span>(<span class="title">self</span>):
        # <span class="title">Create</span> <span class="title">the</span> <span class="title">author</span>
        <span class="title">author</span> = <span class="title">User</span>.<span class="title">objects</span>.<span class="title">create_user</span>('<span class="title">testuser</span>', '<span class="title">user</span>@<span class="title">example</span>.<span class="title">com</span>', '<span class="title">password</span>')
        <span class="title">author</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">site</span>
        <span class="title">site</span> = <span class="title">Site</span>()
        <span class="title">site</span>.<span class="title">name</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">domain</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">post</span>
        <span class="title">post</span> = <span class="title">Post</span>()
        <span class="title">post</span>.<span class="title">title</span> = '<span class="title">My</span> <span class="title">first</span> <span class="title">post</span>'
        <span class="title">post</span>.<span class="title">text</span> = '<span class="title">This</span> <span class="title">is</span> [<span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>](<span class="title">http</span>://127.0.0.1:8000/)'
        <span class="title">post</span>.<span class="title">slug</span> = '<span class="title">my</span>-<span class="title">first</span>-<span class="title">post</span>'
        <span class="title">post</span>.<span class="title">pub_date</span> = <span class="title">timezone</span>.<span class="title">now</span>()
        <span class="title">post</span>.<span class="title">author</span> = <span class="title">author</span>
        <span class="title">post</span>.<span class="title">site</span> = <span class="title">site</span>
        <span class="title">post</span>.<span class="title">save</span>()

        # <span class="title">Check</span> <span class="title">new</span> <span class="title">post</span> <span class="title">saved</span>
        <span class="title">all_posts</span> = <span class="title">Post</span>.<span class="title">objects</span>.<span class="title">all</span>()
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">len</span>(<span class="title">all_posts</span>), 1)

        # <span class="title">Fetch</span> <span class="title">the</span> <span class="title">index</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>('/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">title</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">post</span>.<span class="title">title</span> <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">text</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">markdown</span>.<span class="title">markdown</span>(<span class="title">post</span>.<span class="title">text</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">date</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">str</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">year</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">strftime</span>('%<span class="title">b</span>') <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">str</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">day</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">link</span> <span class="title">is</span> <span class="title">marked</span> <span class="title">up</span> <span class="title">properly</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('&lt;<span class="title">a</span> <span class="title">href</span>="<span class="title">http</span>://127.0.0.1:8000/"&gt;<span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>&lt;/<span class="title">a</span>&gt;' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

    <span class="title">def</span> <span class="title">test_post_page</span>(<span class="title">self</span>):
        # <span class="title">Create</span> <span class="title">the</span> <span class="title">author</span>
        <span class="title">author</span> = <span class="title">User</span>.<span class="title">objects</span>.<span class="title">create_user</span>('<span class="title">testuser</span>', '<span class="title">user</span>@<span class="title">example</span>.<span class="title">com</span>', '<span class="title">password</span>')
        <span class="title">author</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">site</span>
        <span class="title">site</span> = <span class="title">Site</span>()
        <span class="title">site</span>.<span class="title">name</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">domain</span> = '<span class="title">example</span>.<span class="title">com</span>'
        <span class="title">site</span>.<span class="title">save</span>()

        # <span class="title">Create</span> <span class="title">the</span> <span class="title">post</span>
        <span class="title">post</span> = <span class="title">Post</span>()
        <span class="title">post</span>.<span class="title">title</span> = '<span class="title">My</span> <span class="title">first</span> <span class="title">post</span>'
        <span class="title">post</span>.<span class="title">text</span> = '<span class="title">This</span> <span class="title">is</span> [<span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>](<span class="title">http</span>://127.0.0.1:8000/)'
        <span class="title">post</span>.<span class="title">slug</span> = '<span class="title">my</span>-<span class="title">first</span>-<span class="title">post</span>'
        <span class="title">post</span>.<span class="title">pub_date</span> = <span class="title">timezone</span>.<span class="title">now</span>()
        <span class="title">post</span>.<span class="title">author</span> = <span class="title">author</span>
        <span class="title">post</span>.<span class="title">site</span> = <span class="title">site</span>
        <span class="title">post</span>.<span class="title">save</span>()

        # <span class="title">Check</span> <span class="title">new</span> <span class="title">post</span> <span class="title">saved</span>
        <span class="title">all_posts</span> = <span class="title">Post</span>.<span class="title">objects</span>.<span class="title">all</span>()
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">len</span>(<span class="title">all_posts</span>), 1)
        <span class="title">only_post</span> = <span class="title">all_posts</span>[0]
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_post</span>, <span class="title">post</span>)

        # <span class="title">Get</span> <span class="title">the</span> <span class="title">post</span> <span class="title">URL</span>
        <span class="title">post_url</span> = <span class="title">only_post</span>.<span class="title">get_absolute_url</span>()

        # <span class="title">Fetch</span> <span class="title">the</span> <span class="title">post</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>(<span class="title">post_url</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">title</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">post</span>.<span class="title">title</span> <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">text</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">markdown</span>.<span class="title">markdown</span>(<span class="title">post</span>.<span class="title">text</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">post</span> <span class="title">date</span> <span class="title">is</span> <span class="title">in</span> <span class="title">the</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">str</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">year</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">strftime</span>('%<span class="title">b</span>') <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)
        <span class="title">self</span>.<span class="title">assertTrue</span>(<span class="title">str</span>(<span class="title">post</span>.<span class="title">pub_date</span>.<span class="title">day</span>) <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)

        # <span class="title">Check</span> <span class="title">the</span> <span class="title">link</span> <span class="title">is</span> <span class="title">marked</span> <span class="title">up</span> <span class="title">properly</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('&lt;<span class="title">a</span> <span class="title">href</span>="<span class="title">http</span>://127.0.0.1:8000/"&gt;<span class="title">my</span> <span class="title">first</span> <span class="title">blog</span> <span class="title">post</span>&lt;/<span class="title">a</span>&gt;' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)


<span class="title">class</span> <span class="title">FlatPageViewTest</span>(<span class="title">BaseAcceptanceTest</span>):
    <span class="title">def</span> <span class="title">test_create_flat_page</span>(<span class="title">self</span>):
        # <span class="title">Create</span> <span class="title">flat</span> <span class="title">page</span>
        <span class="title">page</span> = <span class="title">FlatPage</span>()
        <span class="title">page</span>.<span class="title">url</span> = '/<span class="title">about</span>/'
        <span class="title">page</span>.<span class="title">title</span> = '<span class="title">About</span> <span class="title">me</span>'
        <span class="title">page</span>.<span class="title">content</span> = '<span class="title">All</span> <span class="title">about</span> <span class="title">me</span>'
        <span class="title">page</span>.<span class="title">save</span>()

        # <span class="title">Add</span> <span class="title">the</span> <span class="title">site</span>
        <span class="title">page</span>.<span class="title">sites</span>.<span class="title">add</span>(<span class="title">Site</span>.<span class="title">objects</span>.<span class="title">all</span>()[0])
        <span class="title">page</span>.<span class="title">save</span>()

        # <span class="title">Check</span> <span class="title">new</span> <span class="title">page</span> <span class="title">saved</span>
        <span class="title">all_pages</span> = <span class="title">FlatPage</span>.<span class="title">objects</span>.<span class="title">all</span>()
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">len</span>(<span class="title">all_pages</span>), 1)
        <span class="title">only_page</span> = <span class="title">all_pages</span>[0]
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_page</span>, <span class="title">page</span>)

        # <span class="title">Check</span> <span class="title">data</span> <span class="title">correct</span>
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_page</span>.<span class="title">url</span>, '/<span class="title">about</span>/')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_page</span>.<span class="title">title</span>, '<span class="title">About</span> <span class="title">me</span>')
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">only_page</span>.<span class="title">content</span>, '<span class="title">All</span> <span class="title">about</span> <span class="title">me</span>')

        # <span class="title">Get</span> <span class="title">URL</span>
        <span class="title">page_url</span> = <span class="title">str</span>(<span class="title">only_page</span>.<span class="title">get_absolute_url</span>())

        # <span class="title">Get</span> <span class="title">the</span> <span class="title">page</span>
        <span class="title">response</span> = <span class="title">self</span>.<span class="title">client</span>.<span class="title">get</span>(<span class="title">page_url</span>)
        <span class="title">self</span>.<span class="title">assertEquals</span>(<span class="title">response</span>.<span class="title">status_code</span>, 200)

        # <span class="title">Check</span> <span class="title">title</span> <span class="title">and</span> <span class="title">content</span> <span class="title">in</span> <span class="title">response</span>
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">About</span> <span class="title">me</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)
        <span class="title">self</span>.<span class="title">assertTrue</span>('<span class="title">All</span> <span class="title">about</span> <span class="title">me</span>' <span class="title">in</span> <span class="title">response</span>.<span class="title">content</span>)</code></pre>
<p>All we&#39;ve done here is to add the <code>site</code> attribute when creating a new post using the Django database API, and when we create one via the admin, we add an additional <code>site</code> aparameter to the HTTP POST request with a value of 1. Run the tests and they should fail:</p>
<pre><code class="lang-bash">Creating test database <span class="keyword">for</span> alias <span class="string">'default'</span>...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 46, <span class="keyword">in</span> test_create_post
    self.assertEquals(only_post.site.name, <span class="string">'example.com'</span>)
AttributeError: <span class="string">'Post'</span> object has no attribute <span class="string">'site'</span>

----------------------------------------------------------------------
Ran 9 tests <span class="keyword">in</span> 4.313s

FAILED (errors=1)
Destroying test database <span class="keyword">for</span> alias <span class="string">'default'</span>...</code></pre>
<p>So we need to add the <code>site</code> attribute to the <code>Post</code> model. Let&#39;s do that:</p>
<p>``` python blogengine/models.py
from django.db import models
from django.contrib.auth.models import User
from django.contrib.sites.models import Site</p>
<h1 id="create-your-models-here-">Create your models here.</h1>
<p>class Post(models.Model):
    title = models.CharField(max_length=200)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=40, unique=True)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span>
    <span class="keyword">return</span> <span class="string">"/%s/%s/%s/"</span> % (self.pub_date.year, self.pub_date.month, self.slug)

<span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span>
    <span class="keyword">return</span> self.title

<span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span>
    ordering = [<span class="string">"-pub_date"</span>]</code></pre>
<pre><code>
Now create <span class="keyword">and</span> run the migrations - you<span class="attribute">'ll</span> be prompted <span class="keyword">to</span> create a <span class="keyword">default</span> value <span class="keyword">for</span> the site <span class="keyword">attribute</span> as well:

``` bash
(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py schemamigration <span class="comment">--auto blogengine</span>
 ? The field <span class="attribute">'Post</span>.site' does <span class="keyword">not</span> have a <span class="keyword">default</span> specified, yet <span class="keyword">is</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>.
 ? Since you are adding this field, you MUST specify a <span class="keyword">default</span>
 ? value <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">for</span> existing rows. Would you like <span class="keyword">to</span>:
 ?  <span class="number">1.</span> Quit now, <span class="keyword">and</span> add a <span class="keyword">default</span> <span class="keyword">to</span> the field <span class="keyword">in</span> models.py
 ?  <span class="number">2.</span> Specify a one-off value <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">for</span> existing columns now
 ? Please <span class="keyword">select</span> a choice: <span class="number">2</span>
 ? Please enter Python code <span class="keyword">for</span> your one-off <span class="keyword">default</span> value.
 ? The datetime module <span class="keyword">is</span> available, so you can do e.g. datetime.date.today()
 &gt;&gt;&gt; <span class="number">1</span>
 + Added field site <span class="keyword">on</span> blogengine.Post
Created <span class="number">0005</span>_auto__add_field_post_site.py. You can now apply this migration <span class="keyword">with</span>: ./manage.py migrate blogengine
(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py migrate
Running migrations <span class="keyword">for</span> blogengine:
 - Migrating forwards <span class="keyword">to</span> <span class="number">0005</span>_auto__add_field_post_site.
 &gt; blogengine:<span class="number">0005</span>_auto__add_field_post_site
 - Loading initial data <span class="keyword">for</span> blogengine.
Installed <span class="number">0</span> object(s) from <span class="number">0</span> fixture(s)</code></pre>
<p>Our tests should then pass:</p>
<pre><code class="lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database <span class="keyword">for</span> alias <span class="string">'default'</span>...
.........
----------------------------------------------------------------------
Ran 9 tests <span class="keyword">in</span> 4.261s

OK
Destroying test database <span class="keyword">for</span> alias <span class="string">'default'</span>...</code></pre>
<p>Now we can include our full page URL on the post detail page:</p>
<p>``` html templates/blogengine/post_detail.html
{% raw %}{% extends &quot;blogengine/includes/base.html&quot; %}</p>
<pre><code><span class="template_tag">{% <span class="keyword">load</span> custom_markdown %}</span>

<span class="template_tag">{% <span class="keyword">block</span> content %}</span>
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"post"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="variable">{{ object.title }}</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h3</span>&gt;</span><span class="variable">{{ object.pub_date }}</span><span class="tag">&lt;/<span class="title">h3</span>&gt;</span>
    <span class="variable">{{ object.text<span class="filter">|custom</span>_markdown }}</span>

    <span class="tag">&lt;<span class="title">h4</span>&gt;</span>Comments<span class="tag">&lt;/<span class="title">h4</span>&gt;</span>
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"fb-comments"</span> <span class="attribute">data-href</span>=<span class="value">"http://<span class="variable">{{ post.site }}</span><span class="variable">{{ post.get_absolute_url }}</span>"</span> <span class="attribute">data-width</span>=<span class="value">"470"</span> <span class="attribute">data-num-posts</span>=<span class="value">"10"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>

    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>

<span class="template_tag">{% <span class="keyword">endblock</span> %}</span><span class="template_tag">{% endraw %}</span></code></pre>
<pre><code>
If you want <span class="keyword">to</span> customise <span class="keyword">the</span> comments, take a look <span class="keyword">at</span> [<span class="keyword">the</span> documentation <span class="keyword">for</span> Facebook Comments](https://developers.facebook.com/docs/plugins/comments/).

With <span class="keyword">that</span> done, we can commit our changes:

``` bash
git add blogengine/ templates/
git commit -m 'Implemented Facebook comments'</code></pre>
<p>And that wraps up this lesson. As usual, you can easily switch to today&#39;s lesson with <code>git checkout lesson-3</code>. Next time we&#39;ll implement categories and tags, and create an RSS feed for our blog posts.</p>

  </section>
    <section>
        <p>
          3rd January 2014
          
            by Matthew Daly
          
        </p>
    </section>

  <ul class="pager">
      
        <li><a href="/posts/2014-01-25-my-first-yeoman-generator.html">Newer</a></li>
      
      
        <li><a href="/posts/2014-01-02-django-blog-tutorial-the-next-generation-part-2.html">Older</a></li>
      
    </ul>
  <section class="comments">
    
    
        <div class="fb-comments" data-href="http://matthewbdaly.getforge.io/posts/2014-01-03-django-blog-tutorial-the-next-generation-part-3.html" data-width="470" data-num-posts="10"></div>
        </div>
    
  </section>
</article>

        </div>

        <footer>
            <div class="container">
                Copyright Matthew Daly, 2014.
            </div>
        </footer>
        <script type="text/javascript" src="/static/js/dependencies.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
