<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="fb:app_id" content=""/>
        <link rel="stylesheet" type="text/css" href="/static/bower_components/bootstrap-sass/dist/css/bootstrap.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/static/bower_components/flat-ui/dist/css/flat-ui.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/static/bower_components/highlightjs/styles/zenburn.css" media="all" />
        <link rel="alternate" type="application/rss+xml" title="A Series of Quite Extraordinary Events - feed" href="/index.xml" />
        <title>A Series of Quite Extraordinary Events - Django Blog Tutorial - the Next Generation - Part 9</title>
    </head>
    <body>
        <header>
            <div class="container">
                <div class="page-header">
                    <h1>A Series of Quite Extraordinary Events</h1>
                    <h2>Being the blog of Matthew Daly Esquire</h2>
                    <nav>
                        <a href="/">Home</a> | <a href="/archive.html">Archives</a> | <a href="/about.html">About</a> | <a href="/rss.xml">RSS</a>
                    </nav>
                </div>
            </div>
        </header>

        <div class="container">
            <article class="post">
    
  <div class="title">
    <h1><a href="/posts/2014-09-28-django-blog-tutorial-the-next-generation-part-9.html">Django Blog Tutorial - the Next Generation - Part 9</a></h1>
  </div>
  <section>
    <p>Yes, I know the eight instalment was meant to be the last one! Within 24 hours of that post going live, Django 1.7 was released, so naturally I&#39;d like to show you how to upgrade to it.</p>
<p>The biggest change is that Django 1.7 introduces its own migration system, which means South is now surplus to requirements. We therefore need to switch from South to Django&#39;s native migrations. Fortunately, this is fairly straightforward.</p>
<p>First of all, activate your virtualenv:</p>
<pre><code class="lang-bash">virtualenv venv</code></pre>
<p>Then make sure your migrations are up to date:</p>
<pre><code class="lang-bash">python manage.py syncdb
python manage.py migrate</code></pre>
<p>Then, upgrade your Django version and uninstall South:</p>
<pre><code class="lang-bash">pip install Django --upgrade
pip uninstall South
pip freeze &gt; requirements.txt</code></pre>
<p>Next, remove South from <code>INSTALLED_APPS</code> in <code>django_tutorial_blog_ng/settings.py</code>.</p>
<p>You now need to delete all of the numbered migration files in <code>blogengine/migrations/</code>, and the relevant <code>.pyc</code> files, but NOT the directory or the <code>__init__.py</code> file. You can do so with this command on Linux or OS X:</p>
<pre><code class="lang-bash">rm blogengine/migrations/00*</code></pre>
<p>Next, we recreate our migrations with the following command:</p>
<pre><code class="lang-bash">$ python manage.py makemigrations
Migrations <span class="keyword">for</span> <span class="string">'blogengine'</span>:
  0001_initial.py:
    - Create model Category
    - Create model Post
    - Create model Tag
    - Add field tags to post</code></pre>
<p>Then we run the migrations:</p>
<pre><code class="lang-bash">$ python manage.py migrate
Operations to perform:
  Synchronize unmigrated apps: sitemaps, django_jenkins, debug_toolbar
  Apply all migrations: sessions, admin, sites, flatpages, contenttypes, auth, blogengine
Synchronizing apps without migrations:
  Creating tables...
  Installing custom SQL...
  Installing indexes...
Running migrations:
  Applying contenttypes.0001_initial... FAKED
  Applying auth.0001_initial... FAKED
  Applying admin.0001_initial... FAKED
  Applying sites.0001_initial... FAKED
  Applying blogengine.0001_initial... FAKED
  Applying flatpages.0001_initial... FAKED
  Applying sessions.0001_initial... FAKED</code></pre>
<p>Don&#39;t worry too much if the output doesn&#39;t look exactly the same as this - as long as it works, that&#39;s the main thing.</p>
<p>Let&#39;s run our test suite to ensure it works:</p>
<pre><code class="lang-bash">$ python manage.py jenkins
Creating test database <span class="keyword">for</span> alias <span class="string">'default'</span>...
....FF.F.FFFFFF..............
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 385, <span class="keyword">in</span> test_create_post
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

======================================================================
FAIL: test_create_post_without_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 417, <span class="keyword">in</span> test_create_post_without_tag
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

======================================================================
FAIL: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 278, <span class="keyword">in</span> test_delete_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 346, <span class="keyword">in</span> test_delete_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 255, <span class="keyword">in</span> test_edit_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 447, <span class="keyword">in</span> test_edit_post
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 323, <span class="keyword">in</span> test_edit_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_login (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 183, <span class="keyword">in</span> test_login
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

======================================================================
FAIL: test_logout (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 214, <span class="keyword">in</span> test_logout
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

----------------------------------------------------------------------
Ran 29 tests <span class="keyword">in</span> 7.383s

FAILED (failures=9)
Destroying test database <span class="keyword">for</span> alias <span class="string">'default'</span>...</code></pre>
<p>We have an issue here. A load of the tests for the admin interface now fail. If we now try running the dev server, we see this error:</p>
<pre><code class="lang-bash">$ python manage.py runserver
Performing system checks...

System check identified no issues (0 silenced).
September 28, 2014 - 20:16:47
Django version 1.7, using settings <span class="string">'django_tutorial_blog_ng.settings'</span>
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
Unhandled exception <span class="keyword">in</span> thread started by &lt;function wrapper at 0x1024a5ed8&gt;
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/autoreload.py"</span>, line 222, <span class="keyword">in</span> wrapper
    fn(*args, **kwargs)
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/management/commands/runserver.py"</span>, line 132, <span class="keyword">in</span> inner_run
    handler = self.get_handler(*args, **options)
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/staticfiles/management/commands/runserver.py"</span>, line 25, <span class="keyword">in</span> get_handler
    handler = super(Command, self).get_handler(*args, **options)
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/management/commands/runserver.py"</span>, line 48, <span class="keyword">in</span> get_handler
    <span class="keyword">return</span> get_internal_wsgi_application()
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/servers/basehttp.py"</span>, line 66, <span class="keyword">in</span> get_internal_wsgi_application
    sys.exc_info()[2])
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/servers/basehttp.py"</span>, line 56, <span class="keyword">in</span> get_internal_wsgi_application
    <span class="keyword">return</span> import_string(app_path)
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/module_loading.py"</span>, line 26, <span class="keyword">in</span> import_string
    module = import_module(module_path)
  File <span class="string">"/usr/local/Cellar/python/2.7.8_1/Frameworks/Python.framework/Versions/2.7/lib/python2.7/importlib/__init__.py"</span>, line 37, <span class="keyword">in</span> import_module
    __import__(name)
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/django_tutorial_blog_ng/wsgi.py"</span>, line 14, <span class="keyword">in</span> &lt;module&gt;
    from dj_static import Cling
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/dj_static.py"</span>, line 7, <span class="keyword">in</span> &lt;module&gt;
    from django.core.handlers.base import get_path_info
django.core.exceptions.ImproperlyConfigured: WSGI application <span class="string">'django_tutorial_blog_ng.wsgi.application'</span> could not be loaded; Error importing module: <span class="string">'cannot import name get_path_info'</span></code></pre>
<p>Fortunately, the error above is easy to fix by upgrading <code>dj_static</code>:</p>
<pre><code class="lang-bash">pip install dj_static --upgrade
pip freeze &gt; requirements.txt</code></pre>
<p>That resolves the error in serving static files, but not the error with the admin. If you run the dev server, you&#39;ll be able to see that the admin actually works fine. The problem is caused by the test client not following redirects in the admin. We can easily run just the admin tests with the following command:</p>
<pre><code class="lang-bash">$ python manage.py test blogengine.tests.AdminTest
Creating test database <span class="keyword">for</span> alias <span class="string">'default'</span>...
.FF.F.FFFFFF
======================================================================
FAIL: test_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 385, <span class="keyword">in</span> test_create_post
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

======================================================================
FAIL: test_create_post_without_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 417, <span class="keyword">in</span> test_create_post_without_tag
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)
AssertionError: False is not <span class="literal">true</span>

======================================================================
FAIL: test_delete_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 278, <span class="keyword">in</span> test_delete_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_delete_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 346, <span class="keyword">in</span> test_delete_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_category (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 255, <span class="keyword">in</span> test_edit_category
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 447, <span class="keyword">in</span> test_edit_post
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_edit_tag (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 323, <span class="keyword">in</span> test_edit_tag
    self.assertEquals(response.status_code, 200)
AssertionError: 404 != 200

======================================================================
FAIL: test_login (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 183, <span class="keyword">in</span> test_login
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

======================================================================
FAIL: test_logout (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line 214, <span class="keyword">in</span> test_logout
    self.assertEquals(response.status_code, 200)
AssertionError: 302 != 200

----------------------------------------------------------------------
Ran 12 tests <span class="keyword">in</span> 3.283s

FAILED (failures=9)
Destroying test database <span class="keyword">for</span> alias <span class="string">'default'</span>...</code></pre>
<p>Let&#39;s commit our changes so far first:</p>
<pre><code class="lang-bash">git add django_tutorial_blog_ng/ requirements.txt blogengine/
git commit -m <span class="string">'Upgraded to Django 1.7'</span></code></pre>
<p>Now let&#39;s fix our tests. Here&#39;s the amended version of the <code>AdminTest</code> class:</p>
<p>``` python blogengine/tests.py
class AdminTest(BaseAcceptanceTest):
    fixtures = [&#39;users.json&#39;]</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">test_login</span><span class="params">(self)</span>:</span>
    <span class="comment"># Get login page</span>
    response = self.client.get(<span class="string">'/admin/'</span>, follow=<span class="built_in">True</span>)

    <span class="comment"># Check response code</span>
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log in' in response</span>
    self.assertTrue(<span class="string">'Log in'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Log the user in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log out' in response</span>
    self.assertTrue(<span class="string">'Log out'</span> <span class="keyword">in</span> response.content)

<span class="function"><span class="keyword">def</span> <span class="title">test_logout</span><span class="params">(self)</span>:</span>
    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log out' in response</span>
    self.assertTrue(<span class="string">'Log out'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Log out</span>
    self.client.logout()

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/'</span>, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check 'Log in' in response</span>
    self.assertTrue(<span class="string">'Log in'</span> <span class="keyword">in</span> response.content)

<span class="function"><span class="keyword">def</span> <span class="title">test_create_category</span><span class="params">(self)</span>:</span>
    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/blogengine/category/add/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Create the new category</span>
    response = self.client.post(<span class="string">'/admin/blogengine/category/add/'</span>, {
        <span class="string">'name'</span>: <span class="string">'python'</span>,
        <span class="string">'description'</span>: <span class="string">'The Python programming language'</span>
        },
        follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check added successfully</span>
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check new category now in database</span>
    all_categories = Category.objects.all()
    self.assertEquals(len(all_categories), <span class="number">1</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_edit_category</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the category</span>
    category = CategoryFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Edit the category</span>
    response = self.client.post(<span class="string">'/admin/blogengine/category/'</span> + str(category.pk) + <span class="string">'/'</span>, {
        <span class="string">'name'</span>: <span class="string">'perl'</span>,
        <span class="string">'description'</span>: <span class="string">'The Perl programming language'</span>
        }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check changed successfully</span>
    self.assertTrue(<span class="string">'changed successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check category amended</span>
    all_categories = Category.objects.all()
    self.assertEquals(len(all_categories), <span class="number">1</span>)
    only_category = all_categories[<span class="number">0</span>]
    self.assertEquals(only_category.name, <span class="string">'perl'</span>)
    self.assertEquals(only_category.description, <span class="string">'The Perl programming language'</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_delete_category</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the category</span>
    category = CategoryFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Delete the category</span>
    response = self.client.post(<span class="string">'/admin/blogengine/category/'</span> + str(category.pk) + <span class="string">'/delete/'</span>, {
        <span class="string">'post'</span>: <span class="string">'yes'</span>
    }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check deleted successfully</span>
    self.assertTrue(<span class="string">'deleted successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check category deleted</span>
    all_categories = Category.objects.all()
    self.assertEquals(len(all_categories), <span class="number">0</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_create_tag</span><span class="params">(self)</span>:</span>
    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/blogengine/tag/add/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Create the new tag</span>
    response = self.client.post(<span class="string">'/admin/blogengine/tag/add/'</span>, {
        <span class="string">'name'</span>: <span class="string">'python'</span>,
        <span class="string">'description'</span>: <span class="string">'The Python programming language'</span>
        },
        follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check added successfully</span>
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check new tag now in database</span>
    all_tags = Tag.objects.all()
    self.assertEquals(len(all_tags), <span class="number">1</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_edit_tag</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the tag</span>
    tag = TagFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Edit the tag</span>
    response = self.client.post(<span class="string">'/admin/blogengine/tag/'</span> + str(tag.pk) + <span class="string">'/'</span>, {
        <span class="string">'name'</span>: <span class="string">'perl'</span>,
        <span class="string">'description'</span>: <span class="string">'The Perl programming language'</span>
        }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check changed successfully</span>
    self.assertTrue(<span class="string">'changed successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check tag amended</span>
    all_tags = Tag.objects.all()
    self.assertEquals(len(all_tags), <span class="number">1</span>)
    only_tag = all_tags[<span class="number">0</span>]
    self.assertEquals(only_tag.name, <span class="string">'perl'</span>)
    self.assertEquals(only_tag.description, <span class="string">'The Perl programming language'</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_delete_tag</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the tag</span>
    tag = TagFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Delete the tag</span>
    response = self.client.post(<span class="string">'/admin/blogengine/tag/'</span> + str(tag.pk) + <span class="string">'/delete/'</span>, {
        <span class="string">'post'</span>: <span class="string">'yes'</span>
    }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check deleted successfully</span>
    self.assertTrue(<span class="string">'deleted successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check tag deleted</span>
    all_tags = Tag.objects.all()
    self.assertEquals(len(all_tags), <span class="number">0</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_create_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the category</span>
    category = CategoryFactory()

    <span class="comment"># Create the tag</span>
    tag = TagFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/blogengine/post/add/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Create the new post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/add/'</span>, {
        <span class="string">'title'</span>: <span class="string">'My first post'</span>,
        <span class="string">'text'</span>: <span class="string">'This is my first post'</span>,
        <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
        <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
        <span class="string">'slug'</span>: <span class="string">'my-first-post'</span>,
        <span class="string">'site'</span>: <span class="string">'1'</span>,
        <span class="string">'category'</span>: str(category.pk),
        <span class="string">'tags'</span>: str(tag.pk)
    },
    follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check added successfully</span>
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check new post now in database</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_create_post_without_tag</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the category</span>
    category = CategoryFactory()

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Check response code</span>
    response = self.client.get(<span class="string">'/admin/blogengine/post/add/'</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Create the new post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/add/'</span>, {
        <span class="string">'title'</span>: <span class="string">'My first post'</span>,
        <span class="string">'text'</span>: <span class="string">'This is my first post'</span>,
        <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
        <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
        <span class="string">'slug'</span>: <span class="string">'my-first-post'</span>,
        <span class="string">'site'</span>: <span class="string">'1'</span>,
        <span class="string">'category'</span>: str(category.pk)
    },
    follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check added successfully</span>
    self.assertTrue(<span class="string">'added successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check new post now in database</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_edit_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the post</span>
    post = PostFactory()

    <span class="comment"># Create the category</span>
    category = CategoryFactory()

    <span class="comment"># Create the tag</span>
    tag = TagFactory()
    post.tags.add(tag)

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Edit the post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/'</span> + str(post.pk) + <span class="string">'/'</span>, {
        <span class="string">'title'</span>: <span class="string">'My second post'</span>,
        <span class="string">'text'</span>: <span class="string">'This is my second blog post'</span>,
        <span class="string">'pub_date_0'</span>: <span class="string">'2013-12-28'</span>,
        <span class="string">'pub_date_1'</span>: <span class="string">'22:00:04'</span>,
        <span class="string">'slug'</span>: <span class="string">'my-second-post'</span>,
        <span class="string">'site'</span>: <span class="string">'1'</span>,
        <span class="string">'category'</span>: str(category.pk),
        <span class="string">'tags'</span>: str(tag.pk)
    },
    follow=<span class="built_in">True</span>
    )
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check changed successfully</span>
    self.assertTrue(<span class="string">'changed successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check post amended</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)
    only_post = all_posts[<span class="number">0</span>]
    self.assertEquals(only_post.title, <span class="string">'My second post'</span>)
    self.assertEquals(only_post.text, <span class="string">'This is my second blog post'</span>)

<span class="function"><span class="keyword">def</span> <span class="title">test_delete_post</span><span class="params">(self)</span>:</span>
    <span class="comment"># Create the post</span>
    post = PostFactory()

    <span class="comment"># Create the tag</span>
    tag = TagFactory()
    post.tags.add(tag)

    <span class="comment"># Check new post saved</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">1</span>)

    <span class="comment"># Log in</span>
    self.client.login(username=<span class="string">'bobsmith'</span>, password=<span class="string">"password"</span>)

    <span class="comment"># Delete the post</span>
    response = self.client.post(<span class="string">'/admin/blogengine/post/'</span> + str(post.pk) + <span class="string">'/delete/'</span>, {
        <span class="string">'post'</span>: <span class="string">'yes'</span>
    }, follow=<span class="built_in">True</span>)
    self.assertEquals(response.status_code, <span class="number">200</span>)

    <span class="comment"># Check deleted successfully</span>
    self.assertTrue(<span class="string">'deleted successfully'</span> <span class="keyword">in</span> response.content)

    <span class="comment"># Check post deleted</span>
    all_posts = Post.objects.all()
    self.assertEquals(len(all_posts), <span class="number">0</span>)</code></pre>
<pre><code>
<span class="comment">There</span> <span class="comment">are</span> <span class="comment">two</span> <span class="comment">main</span> <span class="comment">issues</span> <span class="comment">here</span>. <span class="comment">The</span> <span class="comment">first</span> <span class="comment">is</span> <span class="comment">that</span> <span class="comment">when</span> <span class="comment">we</span> <span class="comment">try</span> <span class="comment">to</span> <span class="comment">edit</span> <span class="comment">or</span> <span class="comment">delete</span> <span class="comment">an</span> <span class="comment">existing</span> <span class="comment">item</span>, <span class="comment">or</span> <span class="comment">refer</span> <span class="comment">to</span> <span class="comment">it</span> <span class="comment">when</span> <span class="comment">creating</span> <span class="comment">something</span> <span class="comment">else</span>, <span class="comment">we</span> <span class="comment">can</span> <span class="comment">no</span> <span class="comment">longer</span> <span class="comment">rely</span> <span class="comment">on</span> <span class="comment">the</span> <span class="comment">number</span> <span class="comment">representing</span> <span class="comment">the</span> <span class="comment">primary</span> <span class="comment">key</span> <span class="comment">being</span> <span class="comment">set</span> <span class="comment">to</span> <span class="comment">1</span>. <span class="comment">So</span> <span class="comment">we</span> <span class="comment">need</span> <span class="comment">to</span> <span class="comment">specifically</span> <span class="comment">obtain</span> <span class="comment">this</span>, <span class="comment">rather</span> <span class="comment">than</span> <span class="comment">hard</span>-<span class="comment">coding</span> <span class="comment">it</span> <span class="comment">to</span> <span class="comment">1</span>. <span class="comment">Therefore</span>, <span class="comment">whenever</span> <span class="comment">we</span> <span class="comment">pass</span> <span class="comment">through</span> <span class="comment">a</span> <span class="comment">number</span> <span class="comment">to</span> <span class="comment">represent</span> <span class="comment">an</span> <span class="comment">item</span> <span class="comment">(with</span> <span class="comment">the</span> <span class="comment">exception</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">site</span>, <span class="comment">but</span> <span class="comment">including</span> <span class="comment">tags</span>, <span class="comment">categories</span> <span class="comment">and</span> <span class="comment">posts)</span>, <span class="comment">we</span> <span class="comment">need</span> <span class="comment">to</span> <span class="comment">instead</span> <span class="comment">fetch</span> <span class="comment">its</span> <span class="comment">primary</span> <span class="comment">key</span> <span class="comment">and</span> <span class="comment">return</span> <span class="comment">it</span>. <span class="comment">So</span>, <span class="comment">above</span> <span class="comment">where</span> <span class="comment">we</span> <span class="comment">try</span> <span class="comment">to</span> <span class="comment">delete</span> <span class="comment">a</span> <span class="comment">post</span>, <span class="comment">we</span> <span class="comment">replace</span> <span class="comment">`1`</span> <span class="comment">with</span> <span class="comment">`str(post</span>.<span class="comment">pk)`</span>. <span class="comment">This</span> <span class="comment">will</span> <span class="comment">solve</span> <span class="comment">a</span> <span class="comment">lot</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">problems</span>. <span class="comment">As</span> <span class="comment">there's</span> <span class="comment">a</span> <span class="comment">lot</span> <span class="comment">of</span> <span class="comment">them</span>, <span class="comment">I</span> <span class="comment">won't</span> <span class="comment">go</span> <span class="comment">through</span> <span class="comment">each</span> <span class="comment">one</span>, <span class="comment">but</span> <span class="comment">you</span> <span class="comment">can</span> <span class="comment">see</span> <span class="comment">the</span> <span class="comment">entire</span> <span class="comment">class</span> <span class="comment">above</span> <span class="comment">for</span> <span class="comment">reference</span>, <span class="comment">and</span> <span class="comment">if</span> <span class="comment">you've</span> <span class="comment">followed</span> <span class="comment">along</span> <span class="comment">so</span> <span class="comment">far</span>, <span class="comment">you</span> <span class="comment">shouldn't</span> <span class="comment">have</span> <span class="comment">any</span> <span class="comment">problems</span>.

<span class="comment">The</span> <span class="comment">other</span> <span class="comment">issue</span> <span class="comment">we</span> <span class="comment">need</span> <span class="comment">to</span> <span class="comment">fix</span> <span class="comment">is</span> <span class="comment">the</span> <span class="comment">login</span> <span class="comment">and</span> <span class="comment">logout</span> <span class="comment">tests</span>. <span class="comment">We</span> <span class="comment">simply</span> <span class="comment">add</span> <span class="comment">`follow=True`</span> <span class="comment">to</span> <span class="comment">these</span> <span class="comment">to</span> <span class="comment">ensure</span> <span class="comment">that</span> <span class="comment">the</span> <span class="comment">test</span> <span class="comment">client</span> <span class="comment">follows</span> <span class="comment">the</span> <span class="comment">redirects</span>.

<span class="comment">Let's</span> <span class="comment">run</span> <span class="comment">our</span> <span class="comment">tests</span> <span class="comment">to</span> <span class="comment">make</span> <span class="comment">sure</span> <span class="comment">they</span> <span class="comment">pass:</span>

<span class="comment">```</span> <span class="comment">bash</span>
<span class="comment">$</span> <span class="comment">python</span> <span class="comment">manage</span>.<span class="comment">py</span> <span class="comment">jenkins</span>
<span class="comment">Creating</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span>
<span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">.</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">Ran</span> <span class="comment">29</span> <span class="comment">tests</span> <span class="comment">in</span> <span class="comment">8</span>.<span class="comment">210s</span>

<span class="comment">OK</span>
<span class="comment">Destroying</span> <span class="comment">test</span> <span class="comment">database</span> <span class="comment">for</span> <span class="comment">alias</span> <span class="comment">'default'</span>.<span class="string">.</span><span class="string">.</span></code></pre>
<p>With that done, you can commit your changes:</p>
<pre><code class="lang-bash">git add blogengine/tests.py
git commit -m <span class="string">'Fixed broken tests'</span></code></pre>
<p>Don&#39;t forget to deploy your changes:</p>
<pre><code class="lang-bash">fab deploy</code></pre>
<p>Our blog has now been happily migrated over to Django 1.7!</p>

  </section>
    <section>
        <p>
          28th September 2014
          
            by Matthew Daly
          
        </p>
    </section>

  <ul class="pager">
      
        <li><a href="/posts/2014-10-05-emacs-lisp-example.html">Newer</a></li>
      
      
        <li><a href="/posts/2014-09-28-changing-date-format-from-dd-slash-mm-slash-yyyy-to-yyyy-mm-dd-in-vim.html">Older</a></li>
      
    </ul>
  <section class="comments">
    
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        window.disqus_identifier="";
        window.disqus_url="http://www.matthewdaly.co.uk/posts/2014-09-28-django-blog-tutorial-the-next-generation-part-9.html";
        window.disqus_title="Django Blog Tutorial - the Next Generation - Part 9";
      </script>
        <script type="text/javascript" src="http://disqus.com/forums/mattbd/embed.js"></script>
        <noscript><a href="http://mattbd.disqus.com/?url=ref">View the discussion thread.</a></noscript>
    
    
  </section>
</article>

        </div>

        <footer>
            <div class="container">
                Copyright Matthew Daly, 2014.
            </div>
        </footer>
        <script type="text/javascript" src="/static/js/dependencies.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
